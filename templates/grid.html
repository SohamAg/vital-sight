{% extends "base.html" %}

{% block title %}Control Center - VitalSight{% endblock %}

{% block extra_head %}
<style>
    @keyframes scan {
        0% { transform: translateY(-100%); }
        100% { transform: translateY(100%); }
    }
    
    .scan-line {
        animation: scan 2s linear infinite;
    }
    
    .stat-card {
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
    }
    
    .stat-card.active {
        ring: 2;
        ring-color: currentColor;
        transform: scale(1.02);
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-white mb-2">VitalSight Control Center</h1>
    <p class="text-gray-400">Monitoring {{ videos|length }} surveillance feeds</p>
</div>

<!-- Alert Summary - Subtle Cards -->
<div class="grid grid-cols-6 gap-3 mb-8">
    <!-- Total Feeds -->
    <div class="stat-card glass rounded-lg p-4 border border-gray-700/50 cursor-pointer"
         data-filter="all">
        <div class="text-xs text-gray-500 mb-1 uppercase tracking-wide">Total</div>
        <div class="text-2xl font-bold text-white mb-1">{{ videos|length }}</div>
        <div class="text-xs text-gray-400">Feeds</div>
    </div>
    
    <!-- Active Alerts -->
    <div class="stat-card glass rounded-lg p-4 border border-gray-700/50 cursor-pointer"
         data-filter="alerts">
        <div class="text-xs text-gray-500 mb-1 uppercase tracking-wide">Active</div>
        <div class="text-2xl font-bold text-white mb-1">{{ videos|selectattr('has_alert')|list|length }}</div>
        <div class="text-xs text-gray-400">Alerts</div>
    </div>
    
    <!-- Critical -->
    <div class="stat-card glass rounded-lg p-4 border border-red-500/20 hover:border-red-500/40 cursor-pointer"
         data-filter="CRITICAL">
        <div class="text-xs text-red-400 mb-1 uppercase tracking-wide flex items-center gap-1">
            <div class="w-2 h-2 rounded-full bg-red-500"></div>
            Critical
        </div>
        <div class="text-2xl font-bold text-red-400 mb-1">{{ videos|selectattr('severity', 'equalto', 'CRITICAL')|list|length }}</div>
        <div class="text-xs text-gray-500">Immediate</div>
    </div>
    
    <!-- High -->
    <div class="stat-card glass rounded-lg p-4 border border-orange-500/20 hover:border-orange-500/40 cursor-pointer"
         data-filter="HIGH">
        <div class="text-xs text-orange-400 mb-1 uppercase tracking-wide flex items-center gap-1">
            <div class="w-2 h-2 rounded-full bg-orange-500"></div>
            High
        </div>
        <div class="text-2xl font-bold text-orange-400 mb-1">{{ videos|selectattr('severity', 'equalto', 'HIGH')|list|length }}</div>
        <div class="text-xs text-gray-500">Urgent</div>
    </div>
    
    <!-- Medium -->
    <div class="stat-card glass rounded-lg p-4 border border-yellow-500/20 hover:border-yellow-500/40 cursor-pointer"
         data-filter="MEDIUM">
        <div class="text-xs text-yellow-400 mb-1 uppercase tracking-wide flex items-center gap-1">
            <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
            Medium
        </div>
        <div class="text-2xl font-bold text-yellow-400 mb-1">{{ videos|selectattr('severity', 'equalto', 'MEDIUM')|list|length }}</div>
        <div class="text-xs text-gray-500">Attention</div>
    </div>
    
    <!-- Low -->
    <div class="stat-card glass rounded-lg p-4 border border-green-500/20 hover:border-green-500/40 cursor-pointer"
         data-filter="LOW">
        <div class="text-xs text-green-400 mb-1 uppercase tracking-wide flex items-center gap-1">
            <div class="w-2 h-2 rounded-full bg-green-500"></div>
            Low
        </div>
        <div class="text-2xl font-bold text-green-400 mb-1">{{ videos|selectattr('severity', 'equalto', 'LOW')|list|length }}</div>
        <div class="text-xs text-gray-500">Routine</div>
    </div>
</div>

<!-- Active Filter Indicator -->
<div id="filterIndicator" class="hidden mb-4 glass rounded-lg p-3 border border-primary/30">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
            </svg>
            <span class="text-sm text-gray-300">Filtering: <span id="filterText" class="font-semibold text-primary"></span></span>
        </div>
        <button onclick="clearFilter()" class="text-xs text-gray-400 hover:text-white transition-colors">
            Clear Filter
        </button>
    </div>
</div>

<!-- Camera Grid -->
<div id="videoGrid" class="grid grid-cols-4 gap-4">
    {% for video in videos %}
    <div class="video-tile group relative glass rounded-lg overflow-hidden 
                border transition-all duration-300 cursor-pointer
                {% if video.severity == 'CRITICAL' %}border-red-500/20 hover:border-red-500/50 hover:shadow-red-500/10
                {% elif video.severity == 'HIGH' %}border-orange-500/20 hover:border-orange-500/50 hover:shadow-orange-500/10
                {% elif video.severity == 'MEDIUM' %}border-yellow-500/20 hover:border-yellow-500/50 hover:shadow-yellow-500/10
                {% elif video.severity == 'LOW' %}border-green-500/20 hover:border-green-500/50 hover:shadow-green-500/10
                {% else %}border-gray-700 hover:border-gray-600{% endif %}
                hover:-translate-y-1 hover:shadow-lg"
         data-video-url="/detail/{{ video.name }}" 
         data-video-id="{{ loop.index }}"
         data-severity="{{ video.severity if video.severity else 'NONE' }}"
         data-has-alert="{{ 'true' if video.has_alert else 'false' }}">
        
        <!-- Video Preview -->
        <div class="relative overflow-hidden bg-black">
            <!-- Subtle scan line for alerts -->
            {% if video.has_alert %}
            <div class="absolute inset-0 pointer-events-none z-10">
                <div class="scan-line absolute w-full h-0.5 
                            {% if video.severity == 'CRITICAL' %}bg-gradient-to-r from-transparent via-red-500/40 to-transparent
                            {% elif video.severity == 'HIGH' %}bg-gradient-to-r from-transparent via-orange-500/40 to-transparent
                            {% elif video.severity == 'MEDIUM' %}bg-gradient-to-r from-transparent via-yellow-500/40 to-transparent
                            {% elif video.severity == 'LOW' %}bg-gradient-to-r from-transparent via-green-500/40 to-transparent
                            {% else %}bg-gradient-to-r from-transparent via-gray-500/40 to-transparent{% endif %}">
                </div>
            </div>
            {% endif %}
            
            <!-- Video element -->
            <video class="w-full h-44 object-cover" 
                   muted loop playsinline preload="auto"
                   src="/video/{{ video.filename }}">
            </video>
            
            <!-- Camera ID -->
            <div class="absolute top-2 left-2 bg-black/60 backdrop-blur-sm px-2 py-1 rounded text-xs font-mono text-gray-300">
                CAM-{{ '%02d'|format(loop.index) }}
            </div>
            
            <!-- Alert Indicator (subtle) -->
            {% if video.has_alert %}
            <div class="absolute top-2 right-2 z-20">
                <div class="w-2 h-2 rounded-full
                            {% if video.severity == 'CRITICAL' %}bg-red-500 shadow-red-500/50
                            {% elif video.severity == 'HIGH' %}bg-orange-500 shadow-orange-500/50
                            {% elif video.severity == 'MEDIUM' %}bg-yellow-500 shadow-yellow-500/50
                            {% elif video.severity == 'LOW' %}bg-green-500 shadow-green-500/50
                            {% else %}bg-gray-500{% endif %} shadow-lg animate-pulse">
                </div>
            </div>
            {% endif %}
            
            <!-- Hover Info -->
            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent 
                        opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end">
                <div class="p-3 w-full">
                    <p class="text-white font-semibold mb-1">{{ video.name }}</p>
                    {% if video.categories %}
                    <div class="flex flex-wrap gap-1">
                        {% for category in video.categories %}
                        <span class="px-2 py-0.5 bg-primary/20 border border-primary/30 rounded text-xs font-mono text-primary">
                            {{ category }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Footer Info -->
        <div class="p-3 bg-gray-900/95 border-t border-gray-800">
            <div class="flex items-center justify-between text-xs">
                <div class="flex-1">
                    <p class="font-medium text-gray-300 truncate">
                        {{ video.name[:20] }}{% if video.name|length > 20 %}...{% endif %}
                    </p>
                    {% if video.has_alert %}
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-gray-500">{{ video.report_count }} alert{% if video.report_count != 1 %}s{% endif %}</span>
                        <span class="px-1.5 py-0.5 rounded text-xs font-medium
                                     {% if video.severity == 'CRITICAL' %}bg-red-500/10 text-red-400
                                     {% elif video.severity == 'HIGH' %}bg-orange-500/10 text-orange-400
                                     {% elif video.severity == 'MEDIUM' %}bg-yellow-500/10 text-yellow-400
                                     {% elif video.severity == 'LOW' %}bg-green-500/10 text-green-400
                                     {% else %}bg-gray-700/20 text-gray-400{% endif %}">
                            {{ video.severity }}
                        </span>
                    </div>
                    {% else %}
                    <p class="text-gray-600 mt-1">No alerts</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    
    {% if videos|length == 0 %}
    <div class="col-span-4 glass rounded-xl p-16 text-center border border-gray-700">
        <div class="text-6xl mb-4 text-gray-600">üìπ</div>
        <h3 class="text-2xl font-bold mb-3 text-gray-300">No Videos Available</h3>
        <p class="text-gray-500 mb-8">Upload a video to start monitoring</p>
        <a href="/upload" class="inline-block px-8 py-3 bg-primary hover:bg-cyan-600 
                                 rounded-lg font-semibold transition-colors text-white">
            Upload Video
        </a>
    </div>
    {% endif %}
</div>

<!-- No Results Message -->
<div id="noResults" class="hidden col-span-4 glass rounded-xl p-12 text-center border border-gray-700">
    <div class="text-5xl mb-4 text-gray-600">üîç</div>
    <h3 class="text-xl font-bold mb-2 text-gray-300">No matching feeds</h3>
    <p class="text-gray-500 mb-6">Try a different filter</p>
    <button onclick="clearFilter()" class="px-6 py-2 bg-primary/10 hover:bg-primary/20 text-primary 
                                           border border-primary/30 rounded-lg transition-all">
        Clear Filter
    </button>
</div>

<script>
    let currentFilter = 'all';
    
    // Filter functionality
    document.querySelectorAll('.stat-card').forEach(card => {
        card.addEventListener('click', function() {
            const filter = this.getAttribute('data-filter');
            applyFilter(filter);
        });
    });
    
    function applyFilter(filter) {
        currentFilter = filter;
        
        // Update active state on cards
        document.querySelectorAll('.stat-card').forEach(card => {
            if (card.getAttribute('data-filter') === filter) {
                card.classList.add('active', 'ring-2');
            } else {
                card.classList.remove('active', 'ring-2');
            }
        });
        
        // Filter videos
        const tiles = document.querySelectorAll('.video-tile');
        let visibleCount = 0;
        
        tiles.forEach(tile => {
            const severity = tile.getAttribute('data-severity');
            const hasAlert = tile.getAttribute('data-has-alert') === 'true';
            let show = false;
            
            if (filter === 'all') {
                show = true;
            } else if (filter === 'alerts') {
                show = hasAlert;
            } else {
                show = severity === filter;
            }
            
            if (show) {
                tile.classList.remove('hidden');
                visibleCount++;
            } else {
                tile.classList.add('hidden');
            }
        });
        
        // Update filter indicator
        const indicator = document.getElementById('filterIndicator');
        const filterText = document.getElementById('filterText');
        const noResults = document.getElementById('noResults');
        
        if (filter !== 'all') {
            indicator.classList.remove('hidden');
            filterText.textContent = filter === 'alerts' ? 'Active Alerts' : filter + ' Priority';
        } else {
            indicator.classList.add('hidden');
        }
        
        // Show/hide no results message
        if (visibleCount === 0) {
            noResults.classList.remove('hidden');
        } else {
            noResults.classList.add('hidden');
        }
    }
    
    function clearFilter() {
        applyFilter('all');
    }
    
    // Video initialization
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            document.querySelectorAll('.video-tile video').forEach((video, index) => {
                video.addEventListener('canplay', function() {
                    const playPromise = this.play();
                    if (playPromise !== undefined) {
                        playPromise
                            .then(() => {
                                // Video playing
                            })
                            .catch(error => {
                                // Autoplay blocked - show play overlay
                                const tile = this.closest('.video-tile');
                                const relative = tile.querySelector('.relative.overflow-hidden');
                                if (relative && !relative.querySelector('.play-overlay')) {
                                    const overlay = document.createElement('div');
                                    overlay.className = 'play-overlay absolute inset-0 flex items-center justify-center bg-black/60 cursor-pointer z-20';
                                    overlay.innerHTML = `
                                        <div class="bg-white/10 backdrop-blur-sm rounded-full p-3 hover:bg-white/20 transition-all">
                                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M8 5v14l11-7z"/>
                                            </svg>
                                        </div>
                                    `;
                                    overlay.onclick = (e) => {
                                        e.stopPropagation();
                                        video.play().then(() => {
                                            overlay.remove();
                                        });
                                    };
                                    relative.appendChild(overlay);
                                }
                            });
                    }
                });
                
                video.addEventListener('error', function(e) {
                    if (this.error) {
                        const tile = this.closest('.video-tile');
                        const relative = tile.querySelector('.relative.overflow-hidden');
                        if (relative) {
                            relative.innerHTML = `
                                <div class="absolute inset-0 flex items-center justify-center bg-black text-red-500">
                                    <div class="text-center">
                                        <div class="text-4xl mb-2">‚ö†Ô∏è</div>
                                        <p class="text-sm">Failed to load</p>
                                    </div>
                                </div>
                            `;
                        }
                    }
                });
                
                video.load();
            });
        }, 100);
    });
    
    // Tile click navigation
    document.querySelectorAll('.video-tile').forEach(tile => {
        tile.addEventListener('click', function(e) {
            if (e.target.closest('.play-overlay')) {
                return;
            }
            const url = this.getAttribute('data-video-url');
            if (url) {
                window.location.href = url;
            }
        });
    });
</script>
{% endblock %}
